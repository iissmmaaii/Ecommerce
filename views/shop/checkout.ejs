<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Complete Payment Process</title>
    <link rel="stylesheet" href="/css/payment.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
</head>
<body>
  <div class="payment-wrapper">
    <div class="payment-container">
      <div class="payment-header">
        <h1><i class="fas fa-shopping-cart"></i> Complete Purchase Process</h1>
      </div>

      <div class="payment-grid">
        <!-- Order Summary -->
        <div class="order-summary">
          <h2><i class="fas fa-list-alt"></i> Order Summary</h2>
          <div class="products-list">
            <% products.forEach(function(product) { %>
              <div class="product-item">
                <img
                  src="<%= product.imageUrl %>"
                  alt="<%= product.title %>"
                  class="product-image"
                />
                <div class="product-details">
                  <h3><%= product.title %></h3>
                  <p><%= product.cartItem.quantity %> Ã— <%= product.price.toFixed(2) %> $</p>
                </div>
                <div class="product-total">
                  <%= (product.cartItem.quantity * product.price).toFixed(2) %> $
                </div>
              </div>
            <% }); %>
          </div>

          <div class="summary-totals">
            <div class="total-row">
              <span>Subtotal:</span>
              <span><%= totalSum.toFixed(2) %> $</span>
            </div>
            <div class="total-row">
              <span>Shipping:</span>
              <span>Free</span>
            </div>
            <div class="total-row grand-total">
              <span>Grand Total:</span>
              <span><%= totalSum.toFixed(2) %> $</span>
            </div>
          </div>
        </div>

        <!-- Payment Form -->
        <div class="payment-section">
          <input type="hidden" name="_csrf" value="<%= crsfToken %>" />
          <h2><i class="fas fa-credit-card"></i> Payment Information</h2>

          <form id="payment-form" class="payment-form">
            <div class="form-group">
              <label for="username"><i class="fas fa-user"></i> Username</label>
              <input
                type="text"
                id="username"
                name="username"
                required
                placeholder="Enter username"
              />
            </div>

            <div class="form-group">
              <label for="email"><i class="fas fa-envelope"></i> Email</label>
              <input
                type="email"
                id="email"
                name="email"
                required
                placeholder="Enter your email"
              />
            </div>

            <div class="form-group">
              <label for="card-number"><i class="fas fa-credit-card"></i> Card Number</label>
              <input
                type="text"
                id="card-number"
                name="cardNumber"
                placeholder="1234 5678 9012 3456"
                required
              />
              <div id="card-number-error" class="error-message"></div>
            </div>

            <div class="form-row">
              <div class="form-group half-width">
                <label><i class="fas fa-calendar-alt"></i> Expiry Date</label>
                <input
                  type="text"
                  id="card-expiry"
                  name="cardExpiry"
                  placeholder="MM/YY"
                  required
                />
              </div>
              <div class="form-group half-width">
                <label><i class="fas fa-lock"></i> CVV</label>
                <input
                  type="password"
                  id="card-cvv"
                  name="cardCvv"
                  placeholder="123"
                  required
                />
              </div>
              <input
                type="hidden"
                id="totalSum"
                name="totalSum"
                value="<%= totalSum %>"
              />
            </div>

            <button type="submit" class="submit-btn">
              <i class="fas fa-lock"></i> Confirm Payment ($)
            </button>

            <div class="payment-methods">
              <div class="payment-method">
                <i class="fab fa-cc-visa"></i>
              </div>
              <div class="payment-method">
                <i class="fab fa-cc-mastercard"></i>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© socket.io client -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

  <script>
    document
      .getElementById("payment-form")
      .addEventListener("submit", async function (e) {
        e.preventDefault();

        console.clear();
        console.log("----- Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹ -----");

        const cardNumber = document
          .getElementById("card-number")
          .value.replace(/\s/g, "");
        console.log("ğŸ“¥ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙØ¯Ø®Ù„:", cardNumber);

        if (!/^\d{16}$/.test(cardNumber)) {
          const errorMsg = "Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 16 Ø±Ù‚Ù…Ù‹Ø§";
          console.error("âŒ Ø®Ø·Ø£ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:", errorMsg);
          document.getElementById("card-number-error").textContent = errorMsg;
          return;
        } else {
          document.getElementById("card-number-error").textContent = "";
        }

        const submitBtn = document.querySelector(".submit-btn");
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
        submitBtn.disabled = true;

        try {
          const amount = parseFloat(document.getElementById("totalSum").value);
          console.log("ğŸ’µ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙØ­ÙˆÙ‘Ù„Ø©:", amount);

          if (isNaN(amount)) {
            throw new Error("Ø§Ù„Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©");
          }

          const paymentData = {
            username: document.getElementById("username").value.trim(),
            email: document.getElementById("email").value.trim(),
            cardNumber: cardNumber,
            cardExpiry: document.getElementById("card-expiry").value.trim(),
            cardCvv: document.getElementById("card-cvv").value.trim(),
            amount: amount,
            timestamp: new Date().toISOString(),
          };

          console.log("ğŸ“¦ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:", JSON.stringify(paymentData, null, 2));

          if (
            !paymentData.username ||
            !paymentData.email ||
            !paymentData.cardExpiry ||
            !paymentData.cardCvv
          ) {
            throw new Error("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");
          }

          // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¨Ù†ÙƒÙŠ
          console.log("ğŸ”„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ù†Ùƒ...");
          const response = await fetch("http://localhost:3001/api/process-payment", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            credentials: "include",
            body: JSON.stringify(paymentData),
          });

          console.log(
            "ğŸ“¬ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ:",
            response.status,
            response.statusText
          );

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const errorMsg = errorData.message || `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`;
            throw new Error(errorMsg);
          }

          const result = await response.json();
          console.log("âœ… Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:", result);

          if (!result.success) {
            throw new Error(result.message || "ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹");
          }

          // âœ”ï¸ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© ØµØ§Ø­Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
          alert(
            "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© ØµØ§Ø­Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚."
          );

          // ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø³Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          await fetch("/cart/delete", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "CSRF-Token": document.querySelector('input[name="_csrf"]').value,
            },
            credentials: "include",
          });

          // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± WebSocket
          listenToPaymentResult(result.transactionId);

          // ğŸ” ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ù…ÙƒÙ† ØªØ­Ø·Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø©)
          // window.location.href = '/';

        } catch (error) {
          console.error("ğŸ”¥ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹:", {
            message: error.message,
            stack: error.stack,
            time: new Date().toISOString(),
          });

          alert(`Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}\nÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰`);
        } finally {
          console.log("----- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© -----");
          submitBtn.innerHTML = originalBtnText;
          submitBtn.disabled = false;
        }
      });

    // Ø¯Ø§Ù„Ø© WebSocket Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¯ÙØ¹
    function listenToPaymentResult(transactionId) {
      const socket = io("http://localhost:3001"); // Ø¹Ù†ÙˆØ§Ù† Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¨Ù†Ùƒ Ù…Ø¹ WebSocket

      socket.on("connect", () => {
        console.log("ğŸ”Œ Ù…ØªØµÙ„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¨Ù†Ùƒ Ø¹Ø¨Ø± WebSocket");
        socket.emit("join-transaction", transactionId);
      });

      socket.on("payment-result", (data) => {
        console.log("ğŸ“² Ø§Ø³ØªÙ„Ù…Øª Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¯ÙØ¹:", data);

        if (data.status === "approved") {
          alert("ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹!");
        } else if (data.status === "rejected") {
          alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹.");
        }

        socket.disconnect();
      });

      socket.on("disconnect", () => {
        console.log("âŒ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¨Ù†Ùƒ");
      });
    }

    console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­");
  </script>
</body>
</html>
